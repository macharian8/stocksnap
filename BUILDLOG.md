# BUILDLOG.md — StockSnap Build Issue Log

Chronological record of native build issues and their resolutions. Consult this before debugging build failures.

---

## [2026-02-21] react-native-reanimated folly header error

**ISSUE**: `npx expo run:ios` fails during pod compilation with folly header incompatibility errors from `react-native-reanimated`. The reanimated package's native code references folly C++ headers that are incompatible with the version bundled in React Native 0.81.5 on Intel Macs with Xcode 16.2.

**RESOLUTION**: Removed `react-native-reanimated` entirely. No application code imports it — it was only listed as a dependency and had its babel plugin in `babel.config.js`. Removed the `react-native-reanimated/plugin` entry from babel plugins array. Package should not be re-added unless the upstream incompatibility is fixed.

---

## [2026-02-21] NitroModules Swift compilation error (react-native-mmkv v4)

**ISSUE**: After removing reanimated, `pod install` fails with `Unable to find a specification for NitroModules depended upon by NitroMmkv`. The `react-native-mmkv` v4.x uses NitroModules (a Nitro-based native module system) which fails to compile on Intel Macs.

**RESOLUTION**: Downgraded `react-native-mmkv` from v4.1.2 to v2.12.2. API changes required:
- `import { createMMKV } from 'react-native-mmkv'` → `import { MMKV } from 'react-native-mmkv'`
- `createMMKV({ id: '...' })` → `new MMKV({ id: '...' })`
- `storage.remove(key)` → `storage.delete(key)`

Also removed `react-native-nitro-modules` which was only needed as a peer dependency of mmkv v3+.

---

## [2026-02-21] xcode-select pointing to wrong path

**ISSUE**: Build tools fail because `xcode-select` points to `/Library/Developer/CommandLineTools` instead of the full Xcode installation, which doesn't include iOS SDK or simulators.

**RESOLUTION**: Run:
```bash
sudo xcode-select -s /Applications/Xcode.app
```

---

## [2026-02-21] iOS Simulator runtime missing

**ISSUE**: `npx expo run:ios` reports "No iOS devices available in Simulator.app". `xcrun simctl list devices available` returns empty list. Xcode is installed but no simulator runtimes are downloaded.

**RESOLUTION**: Install iOS Simulator runtime via Xcode:
1. Open Xcode
2. Go to Settings (Cmd+,) > Platforms
3. Click "+" and download iOS runtime
4. Alternatively: `xcodebuild -downloadPlatform iOS` from terminal

---

## [2026-02-22] ios/ directory deleted for clean regeneration

**ISSUE**: After multiple dependency changes (removing reanimated, downgrading mmkv, removing nitro-modules), the `ios/` directory contained stale pod configurations and build artifacts.

**RESOLUTION**: Deleted `ios/` entirely with `rm -rf ios/`. It will be regenerated by `npx expo run:ios` on next build, picking up the current dependency state cleanly. This is the recommended approach after native dependency changes in Expo projects.

---

## [2026-02-24] Code signing invalidated after native rebuild with camera entitlements

**ISSUE**: After Opus rebuilt the native binary with camera permission changes (new entitlements added), the iPhone refused to launch the app — "Untrusted Developer" / "Could not launch" errors even though the device had previously trusted the certificate.

**CAUSE**: Adding new entitlements (camera, microphone) generates a new binary signature. iOS treats this as a new, untrusted certificate even if it is the same Apple ID. The previous trust is scoped to the old signature.

**RESOLUTION**:
1. On iPhone: Settings → General → VPN & Device Management → find the developer certificate → Trust
2. In Xcode: open `ios/stocksnap.xcworkspace` → Signing & Capabilities → register device if needed
3. Rebuild: `npx expo run:ios --device "Omnius"` (replace "Omnius" with your device name)

**NOTE**: Free Apple Developer accounts sign certificates valid for only 7 days. After expiry, repeat steps 2–3. Paid developer accounts get 1-year certificates.

---

## [2026-02-24] SIGABRT crash when SaleSheet renders after QR scan

**ISSUE**: On physical iPhone 13 mini, scanning a QR code finds the item correctly (`showSheet = true` logged) but the app crashes immediately with `SIGABRT / abort() called / NSMutableDictionary initWithContentsOfFile`. The React `ErrorBoundary` does not catch it — it is a native-level crash.

**CAUSE**: `CameraView` (expo-camera) was rendered inside the content area as a wrapper component. When `showSheet = true`, React Native's `Modal` with `animationType="slide"` causes iOS to present a new `UIViewController`. UIKit signals the active `AVCaptureSession` to suspend. expo-camera's native suspend handler performs an `NSMutableDictionary initWithContentsOfFile` read to persist camera state. If the session is still running at the moment Modal presents, that read races with the presentation and calls `abort()`.

**FIX**: Moved `CameraView` to the screen root level, absolutely positioned (`position: absolute, top: 0, left: 0, right: 0, bottom: 0`), rendered behind all other views. Added `!showSheet` to the render guard so the `AVCaptureSession` is fully torn down before the Modal becomes visible. The overlay UI (scan frame, manual entry) is now a transparent sibling View — the root-level camera shows through it.

```tsx
// CameraView at screen root — unmounted before Modal presents
{!IS_SIMULATOR && cameraAvailable && !showSheet ? (
  <CameraView
    style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0 }}
    facing="back"
    barcodeScannerSettings={{ barcodeTypes: ['qr'] }}
    onBarcodeScanned={handleBarcodeScan}
  />
) : null}
```

When the sale sheet closes, `showSheet = false` → `CameraView` remounts → session restarts. `handleBarcodeScan` is memoised so the new `CameraView` instance gets the same stable callback.

---
